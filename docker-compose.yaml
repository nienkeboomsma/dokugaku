version: '3.8'

services:
  ichiran:
    container_name: ichiran
    build:
      context: .
      dockerfile: ./services/ichiran/docker/ichiran/Dockerfile
    depends_on:
      ichiran-db:
        condition: service_healthy
        restart: true
    environment:
      ICHIRAN_PORT: ${ICHIRAN_PORT}
      POSTGRES_PASSWORD: ${ICHIRAN_PG_PASSWORD}
    networks:
      - dokugaku
      - ichiran
    ports:
      - '${ICHIRAN_PORT}:${ICHIRAN_PORT}'
    restart: always
    ### for dev use only ###
    volumes:
      - ./services/ichiran/src:/app/services/ichiran/src
  ichiran-db:
    container_name: ichiran-db
    build:
      args:
        ICHIRAN_PGDUMP: ${ICHIRAN_PGDUMP}
      context: .
      dockerfile: ./services/ichiran/docker/ichiran-db/Dockerfile
    environment:
      PGDATA: '/var/lib/postgresql/data/pgdata'
      POSTGRES_PASSWORD: ${ICHIRAN_PG_PASSWORD}
    healthcheck:
      test: pg_isready -h ichiran-db || exit 1
      interval: 15s
      timeout: 30s
      retries: 999999
      start_period: 15s
    networks:
      - ichiran
    restart: always
    shm_size: 1gb
    volumes:
      - ichiran-db:/var/lib/postgresql/data
  mokuro:
    container_name: mokuro
    build:
      context: .
      dockerfile: ./services/mokuro/Dockerfile
    environment:
      MOKURO_PORT: ${MOKURO_PORT}
    networks:
      - dokugaku
    ports:
      - '${MOKURO_PORT}:${MOKURO_PORT}'
    privileged: true
    restart: always
    volumes:
      - files:/dokugaku

networks:
  dokugaku:
  ichiran:

volumes:
  ichiran-db:
  files:
